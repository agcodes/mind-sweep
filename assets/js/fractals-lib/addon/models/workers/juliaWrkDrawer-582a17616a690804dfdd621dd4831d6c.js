import Palette from"./palette";import Canvas2DDrawer from"./canvas2DDrawer";import Complex from"./complex";import Color from"./color";export default class JuliaWrkDrawer{constructor(t){if(this.id=t,!t)throw"L'Id d'une zone de dessin est obligatoire pour creer une instance de cet objet.";this._me=this,this._recalc=!0,this._drawer=new Canvas2DDrawer(t),this._buffer=this._drawer.getBackBuffer(),this._width=this._drawer.getWidth(),this._height=this._drawer.getHeight(),this._maxIter=200,this._minIter=50,this._iteration=this._maxIter,this._palette=new Palette,this._nbWorkers=4,this._jobs=[],this._jobsInProgress=0,this._c=new Complex(-.85,.2),this._degA=0,this._degB=0,this._animateFlag=!1,this._subscriberList=[]}getConstant(){return this._c}setConstant(t,s){this._c.a=t,this._c.b=s,this._recalc=!0,this.process()}createPalette(t,s,e,i){for(var r=1,h=[],a=arguments.length;r<a;++r)h.push(arguments[r]);this._palette.create(t,h)}animate(){this._animateFlag?(this._degA+=.01,this._degB+=.001,this.setConstant(Math.cos(this._degA),Math.sin(this._degB))):setTimeout((function(){this.animate()}),100)}setAnimate(t){this._degA=Math.acos(this._c.a),this._degB=Math.asin(this._c.b),this._animateFlag=t,this._iteration=this._animateFlag?this._minIter:this._maxIter}start(){var t=0,s=new Color(0,0,0,255,0),e=new Color(0,0,255,255,20),i=new Color(0,255,255,255,40),r=new Color(255,255,0,255,60),h=new Color(255,0,0,255,80),a=new Color(0,0,0,255,100);this.createPalette(256,s,e,i,r,h,a);const o=this;for(t=0;t<this._nbWorkers;t++)this._jobs[t]={worker:new Worker("../dist/assets/js/juliaWrk-852b585df81320bca7a1893383bc61e5.js"),status:0,params:null},this._jobs[t].worker.addEventListener("message",(function(t){o.jobHandler(t)}),!1);this.process()}draw(){null!=this._buffer&&(this._drawer.setBackBuffer(this._buffer),this.animate())}invalidate(){this.process();const t=this;requestAnimationFrame((function(){t.draw()}))}process(t,s){if(this._jobsInProgress<1&&(this._buffer=this._drawer.getBackBuffer(),null!=t&&null!=s&&(this._c=new Complex(t,s)),this._recalc&&this._jobsInProgress<1)){this._recalc=!1;var e,i,r,h,a=this._width/this._nbWorkers*2,o=this._height/2,_=0;for(e=0,i=0,r=0,h=o,_=0;_<this._nbWorkers;_++)this._jobs[_].worker.status=0,r<this._width?(e=r,r+=a):(e=0,r=a,h<this._height?(i=h,h+=o):(i=0,h=o)),this._jobs[_].params={wid:_,x1:e,y1:i,x2:r,y2:h,c:{a:this._c.a,b:this._c.b},iter:this._iteration,width:this._width,height:this._height},this._jobs[_].worker.postMessage(this._jobs[_].params),this._jobsInProgress++}}jobHandler(t){var s=new Uint8ClampedArray(t.data);if(null!=s){var e,i,r,h=s[0],a=this._jobs[h].params,o=a.x2-a.x1,_=a.y2-a.y1;for(this._jobs[h].worker.status=1,this._jobsInProgress--,i=0;i<_;i++)for(e=0;e<o;e++)r=this._palette.getColor(s[1+i*o+e]),this._buffer[(a.y1+i)*a.width+(a.x1+e)]=this._drawer.pixel(r.r,r.g,r.b,r.a);this._jobsInProgress<1&&(this.invalidate(),this.notify(this._c))}}subscribe(t){this._subscriberList.push(t)}notify(t){for(var s=this._subscriberList.length;s;)s-=1,this._subscriberList[s](t.a,t.b)}}