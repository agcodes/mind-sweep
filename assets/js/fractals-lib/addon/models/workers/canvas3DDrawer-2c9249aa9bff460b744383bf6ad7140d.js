export default class Canvas3DDrawer{constructor(t,i){this._me=this,this._pool={shaders:[],vbo:[],ibo:[],cbo:[],normals:[],uv:[],light:[],textures:[],lastOf:function(t){return t instanceof Array?t[t.length-1]:null}},this._width,this._height,this._time=0,this._deltatime=0,this._canvas=t?document.getElementById(t):null,this._gl=null,this._gl=this._canvas.getContext("webgl")||this._canvas.getContext("experimental-webgl"),this._gl.matrix={projection:mat4.create(),view:mat4.create()},this.context=this._gl,this.vec2={x:0,y:0},this._width=this.getWidth(),this._height=this.getHeight(),this._gl.viewport(0,0,this._width,this._height),this._gl.clearColor(0,0,0,1),this._gl.clear(this._gl.COLOR_BUFFER_BIT|this._gl.DEPTH_BUFFER_BIT),this.timeTicks=function(){this._time&&(this._deltatime=(new Date).getTime()-this._time),this._time=(new Date).getTime()},this._frame=0}getWidth=function(){return this._canvas.width};getHeight=function(){return this._canvas.height};loadShaders(t,i){const s=this;function r(){var r=this,e=r.i;if(4==r.readyState){var h=t[e].slice(8,10),a=s.addShader(r.responseText,h);! --l&&"function"==typeof i&&i({id:a,type:h,name:t[e]})}}t=[].concat(t);for(var e,h=!!i,a=t.length,l=a;a--;)(e=new XMLHttpRequest).i=a,e.open("get",t[a],h),h&&(e.onreadystatechange=r),e.send(null),r.call(e);return t}addShader(t,i){var s="fs"==i?this._gl.FRAGMENT_SHADER:this._gl.VERTEX_SHADER,r=this._gl.createShader(s);if(this._gl.shaderSource(r,t),this._gl.compileShader(r),!this._gl.getShaderParameter(r,this._gl.COMPILE_STATUS))throw this._gl.getShaderInfoLog(r);return this._pool.shaders.push(r),this._pool.shaders.length-1}addVShader(t){return this.addShader(shader,"vs")}addFShader(t){return this.addShader(shader,"fs")}getShader(t){return t>-1&&t<this._pool.shaders.length?this._pool.shaders[t]:null}setShaderProgram(t,i){var s=this.getShader(t),r=this.getShader(i);this._gl.shader={program:this._gl.createProgram(),uniforms:{},attribs:{}},this._gl.attachShader(this._gl.shader.program,s),this._gl.attachShader(this._gl.shader.program,r),this._gl.linkProgram(this._gl.shader.program),this._gl.getProgramParameter(this._gl.shader.program,this._gl.LINK_STATUS)||alert("Could not initialise shaders"),this._gl.useProgram(_gl.shader.program),this.bindUniformParameter("uTime"),this.bindUniformParameter("uMouse"),this.bindUniformParameter("uResolution"),this.bindUniformParameter("uBackbuffer"),this.bindUniformParameter("uSurfaceSize"),this.bindAttribParameter("aVertexPosition",0),this._gl.enableVertexAttribArray(this._gl.shader.attribs.aVertexPosition)}bindUniformParameter(t){void 0===this._gl.shader.uniforms&&(this._gl.shader.uniforms={}),void 0===this._gl.shader.uniforms[t]&&(this._gl.shader.uniforms[t]=this._gl.getUniformLocation(this._gl.shader.program,t))}bindAttribParameter(t,i){void 0===this._gl.shader.attribs&&(this._gl.shader.attribs={}),void 0===this._gl.shader.attribs[t]&&(this._gl.bindAttribLocation(this._gl.shader.program,i,t),this._gl.shader.attribs[t]=this._gl.getAttribLocation(_gl.shader.program,t))}setUniformInteger(t,i,s,r,e){void 0===this._gl.shader.uniforms[t]&&this.bindUniformParameter(t),void 0!==e?this._gl.uniform4i(this._gl.shader.uniforms[t],i,s,r,e):void 0!==r?this._gl.uniform3i(this._gl.shader.uniforms[t],i,s,r):void 0!==s?this._gl.uniform2i(this._gl.shader.uniforms[t],i,s):void 0!==i&&this._gl.uniform1i(this._gl.shader.uniforms[t],i)}setUniformFloat(t,i,s,r,e){void 0===this._gl.shader.uniforms[t]&&this.bindUniformParameter(t),void 0!==e?this._gl.uniform4f(this._gl.shader.uniforms[t],i,s,r,e):void 0!==r?this._gl.uniform3f(this._gl.shader.uniforms[t],i,s,r):void 0!==s?this._gl.uniform2f(this._gl.shader.uniforms[t],i,s):void 0!==i&&this._gl.uniform1f(this._gl.shader.uniforms[t],i)}setUniformMatrix(t,i,s){void 0===this._gl.shader.uniforms[t]&&this.bindUniformParameter(t),16==s.length?this._gl.uniformMatrix4fv(this._gl.shader.uniforms[t],i,s):9==s.length?this._gl.uniformMatrix3fv(this._gl.shader.uniforms[t],i,s):4==s.length&&this._gl.uniformMatrix2fv(this._gl.shader.uniforms[t],i,s)}setPalette(t){this._gl.palette=this._gl.createTexture(),this._gl.bindTexture(this._gl.TEXTURE_2D,this._gl.palette),this._gl.shader.program.paletteSamplerUniform=this._gl.getUniformLocation(this._gl.shader.program,"uPaletteSampler"),this._gl.texImage2D(this._gl.TEXTURE_2D,0,_gl.RGBA,t.length/4,1,0,this._gl.RGBA,this._gl.UNSIGNED_BYTE,t),this._gl.texParameteri(this._gl.TEXTURE_2D,_gl.TEXTURE_MAG_FILTER,this._gl.NEAREST),this._gl.texParameteri(this._gl.TEXTURE_2D,_gl.TEXTURE_MIN_FILTER,this._gl.NEAREST),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE),this._gl.generateMipmap(this._gl.TEXTURE_2D),this._gl.bindTexture(this._gl.TEXTURE_2D,null)}addLight(t,i,s){return 0}addNormal(t){return this._pool.normals.push(this._gl.createBuffer()),this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._pool.lastOf(this._pool.normals)),this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(t),this._gl.STATIC_DRAW),this._pool.normals.length-1}addUV(t){return _pool.uv.push(this._gl.createBuffer()),this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._pool.lastOf(this._pool.uv)),this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(t),this._gl.STATIC_DRAW),this._pool.uv.length-1}addMesh(t,i){return this._pool.vbo.push(this._gl.createBuffer()),this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._pool.lastOf(_pool.vbo)),this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(t),this._gl.STATIC_DRAW),i instanceof Array&&(this._pool.ibo.push(this._gl.createBuffer()),this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._pool.lastOf(_pool.ibo)),this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(i),this._gl.STATIC_DRAW)),this._pool.vbo.length-1}setProjectionMatrix(t){this._gl.matrix.projection=t}setViewMatrix(t){this._gl.matrix.view=t}loadIdentity(){this.setViewMatrix(mat4.identity())}setMatrixUniforms(){var t=mat3.create();this.bindUniformParameter("uMatrixProjection"),this.bindUniformParameter("uMatrixView"),this.bindUniformParameter("uMatrixNormal"),mat4.toInverseMat3(this._gl.matrix.view,t),mat3.transpose(t),this._gl.uniformMatrix4fv(this._gl.shader.uniforms.uMatrixProjection,!1,this._gl.matrix.projection),this._gl.uniformMatrix4fv(this._gl.shader.uniforms.uMatrixView,!1,this._gl.matrix.view),this._gl.uniformMatrix3fv(this._gl.shader.uniforms.uMatrixNormal,!1,t)}translateView(t){mat4.translate(this._gl.matrix.view,t)}draw(){this._frame++,this.timeTicks();var t=this._pool.vbo.length,i=0;this.setProjectionMatrix(mat4.ortho(-1,1,-1,1,.1,100)),this.loadIdentity(),this.translateView([-0,0,-6]),this._gl.uniform1f(this._gl.shader.uniforms.uTime,this._frame/10),this._gl.uniform2f(this._gl.shader.uniforms.uResolution,this._width,this._height),void 0!==this._gl.palette&&this._gl.bindTexture(this._gl.TEXTURE_2D,this._gl.palette);for(var s=0;s<t;s++)this._gl.bindBuffer(this._gl.ARRAY_BUFFER,_pool.vbo[s]),this._gl.vertexAttribPointer(this._gl.shader.attribs.aVertexPosition,3,this._gl.FLOAT,!1,0,0),null!=_pool.ibo[s]&&this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(_pool.ibo[s]),this._gl.STATIC_DRAW),null!=_pool.cbo[s]&&this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,new Float32Array(_pool.cbo[s]),this._gl.STATIC_DRAW),this.setMatrixUniforms(),i=this._gl.getBufferParameter(this._gl.ARRAY_BUFFER,this._gl.BUFFER_SIZE)/12,this._gl.drawArrays(this._gl.TRIANGLE_STRIP,0,i)}getQuad(){return new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0])}}