import CComplex from"./CComplex";import MersenneTwister from"calc-utils/models/MersenneTwister";import FractalParameters from"./fractal-parameters";import Fractal from"./fractal";export default class Mandelbrot extends Fractal{constructor(){super(),this.params=new FractalParameters,this.mersenneTwister=new MersenneTwister,this.colorsService=null,this.grid=[],this.tmp=[],this.ptsTmp=[],this.iterationsPts=null,this.it=0,this.n=0,this.z=null,this.limitWidth=0,this.initialMaxIterations=0,this.nOccurrences=[],this.currentFunction=null,this.functionDefinition="",this.ifsFunctionDefinition="",this.derivativeCalculation=!1}setParameters(t){this.params=t,this.derivativeCalculation=18==this.params.method||19==this.params.method,this.params.setC0()}clearPtsTmp(){this.ptsTmp=[]}initialize(t,s){this.colorsService=t,this.params=s,this.ptsTmp=[],this.it=0,this.nOccurrences=[];for(let t=0;t<this.params.maxIterations+1;t++)this.nOccurrences.push(0);return"function"==typeof this.params.currentFunction}randomBetween(t,s,a){return t-=a,s+=a,Math.round(1e5*(this.mersenneTwister.rand()*(s-t)+t))/1e5}setRandomPoint(){return[Math.round(1e7*this.randomBetween(this.params.x1,this.params.x2,0))/1e7,Math.round(1e7*this.randomBetween(this.params.y1,this.params.y2,0))/1e7,1]}getRandomPoints(t,s){for(let a=0;a<t;a++){const t=this.setRandomPoint(),a=this.getPt(t[0],t[1],this.params.z0,s);a&&this.ptsTmp.push(a)}return this.ptsTmp}getPt(t,s,a,i){this.initResults();const r=this.params.ifsParams.mode>0?this.getIFSn(t,s,a,[]):this.getI(t,s,a);return this.nOccurrences[r]++,0!==i?this.getMandelbrotPt(t,s,r*i,r):this.getMandelbrotPt(t,s,a,r)}getI(t,s,a){let i=null===this.params.c0?new CComplex(t,s,a):this.params.c0,r=this.params.zFromOrigin?new CComplex(0,0,0):new CComplex(t,s,a),e=this.derivativeCalculation?new CComplex(1,0):null,h=0;const n=this.params.maxIterations,m=this.params.target;do{if(r=this.fZ(r,i,h),null===r)break;this.derivativeCalculation&&(e=this.derivativeZ(r,i,h).mul(e)),this.setMinLp(r),h++}while(this.setResult(r.squaresSum())<m&&h<n);return this.saveZ(r),this.saveDz(e),this.it++,h}getMandelbrotPt(t,s,a,i){if(null!==this.params.itInterval&&(i<this.params.itInterval[0]||i>this.params.itInterval[1]))return null;if(this.params.render3D)if(1===this.params.zMethod);else if(this.params.zThresholds&&this.params.zValues){for(let t=0;t<this.params.zThresholds.length;t++)if(this.params.zThresholds[t]>=i){a=this.params.zValues[t];break}}else a=-Math.log10(i);const r=this.getV(this.params.method,i,t,s);let e=r,h=r,n=r,m=r,o=r,p=r,l=r,u=r;if(this.params.innerMethod>0&&(e=this.getV(this.params.innerMethod,i),h=e,n=e,m=e),3===this.params.zMethod&&(a=Math.log10(i)),13===this.params.method)e=i,h=this.getLastMagnitude(),n=h,m=h,o=i,p=this.getLastMagnitude(),l=p,u=p;return null!==this.params.varInterval&&(r<this.params.varInterval[0]||r>this.params.varInterval[1])?null:!0===this.params.inner&&i===this.params.maxIterations?[t,s,a,this.params.getInnerColor(r,e,h,n,m,!1),i]:!0===this.params.out&&i<this.params.maxIterations&&i>=this.params.minIterations?[t,s,a,this.params.getDrColor(i,r,o,p,l,u),i,r]:null}getIFSn(t,s,a){return this.iterationsPts=[],this.it=0,this.saveDz(new CComplex(1,0)),this.getIFSi(this.params.zFromOrigin?new CComplex(0,0,0):new CComplex(t,s,a),null===this.params.c0?new CComplex(t,s,a):this.params.c0,0,1)}getIFSi(t,s,a,i){if(this.it++,this.it>this.params.maxIterations||a>=this.params.ifsParams.maxIterations)return 1==i&&this.saveZ(t),this.derivativeCalculation&&1==i&&this.saveDz(this.derivativeZ(t,s,this.it).mul(this.lastDz)),11===this.params.selectMode?1:0;const r=t.squaresSum();return 1==i&&this.setResult(r),r>this.params.target?(1==i&&this.saveZ(t),this.derivativeCalculation&&1==i&&this.saveDz(this.derivativeZ(t,s,this.it).mul(this.lastDz)),11===this.params.selectMode?0:1):this.getIFSi(this.fZ(t,s,a+1),s,a+1,1)+this.getIFSi(this.getIfsZ(t,s,a+1),s,a+1,2)}fZ(t,s,a){return t=this.params.breakPtParams&&a>this.params.breakPtParams.min?this.addNoise(this.params.currentFunction(t,this.params.breakPtParams.base,new CComplex(this.params.breakPtParams.a,this.params.breakPtParams.b,this.params.breakPtParams.c),this.params.breakPtParams.f,this.params.args,a),a):this.addNoise(this.params.currentFunction(t,this.params.base,s,this.params.f,this.params.args,a),a),null!==this.iterationsPts&&this.addIterationPt(t,this.it,this.iterationsPts),t}derivativeZ(t,s,a){return this.params.derivativeFunction?this.params.derivativeFunction(t,this.params.base,s):this.fZ(t.add(this.cDerivative),s,a).sub(this.fZ(t,s,a)).div(this.cDerivative)}getIfsZ(t,s,a){return this.params.ifsParams.currentFunction&&(t=this.params.ifsParams.currentFunction(t,this.params.ifsParams.base,null!==this.params.ifsParams.c0?this.params.ifsParams.c0:s,this.params.ifsParams.f,this.params.ifsParams.args))&&this.params.ifsParams.noise?t.addValuesIn(this.params.ifsParams.noise[0]*a,this.params.ifsParams.noise[1]*a,this.params.ifsParams.noise[2]*a):t}addIterationPt(){}}